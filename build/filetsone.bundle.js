var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{A:()=>a});class i{constructor(){this.url="",this.uploadOnDrop=!1,this.chunkSize=10485760}}class s extends i{constructor(){super(...arguments),this.initiateMultipartUrl="",this.fetchPresignUrl="",this.finalizeMultipartUrl=""}valid(){return""!==this.initiateMultipartUrl&&""!==this.fetchPresignUrl&&""!==this.finalizeMultipartUrl}}var r=function(t,e,i,s){return new(i||(i=Promise))((function(r,o){function n(t){try{a(s.next(t))}catch(t){o(t)}}function l(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(n,l)}a((s=s.apply(t,e||[])).next())}))};class o{constructor(){this.settings=new s}upload(t,e){return r(this,void 0,void 0,(function*(){if(this.settings=t.s3Settings,this.filetsone=t,!this.settings.valid())throw new Error("Settings invalid");const i=this.splitFile(e),s=yield this.initiateUpload(e),r=yield this.getPresignedUrls(s,i.length),o=yield this.uploadChunks(r,i,e);return this.finalizeUpload(s,o)}))}splitFile(t){const e=Math.ceil(t.size/this.settings.chunkSize),i=[];for(let s=0;s<e;s++)i.push(t.slice(s*this.settings.chunkSize,(s+1)*this.settings.chunkSize));return i}initiateUpload(t){return r(this,void 0,void 0,(function*(){this.filetsone&&this.filetsone.triggerHook("initiate_multipart_upload",t,this.settings.initiateMultipartUrl);const e=yield fetch(this.settings.initiateMultipartUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t.name})});if(!e.ok)throw new Error("Failed to initiate upload");const{key:i}=yield e.json();return i}))}getPresignedUrls(t,e){return r(this,void 0,void 0,(function*(){this.filetsone&&this.filetsone.triggerHook("get_multipart_presign_urls",t,e);const i=[];for(let s=1;s<=e;s++){const e=yield fetch(`${this.settings.fetchPresignUrl}?requestId=${t}&partNumber=${s}`);if(!e.ok)throw new Error(`Failed to get presigned URL for part ${s}`);const{url:r}=yield e.json();i.push(r)}return i}))}uploadChunks(t,e,i){return r(this,void 0,void 0,(function*(){this.filetsone&&this.filetsone.triggerHook("upload_multipart_chunk",t,e);const s=[];let r=[];for(let o=0;o<e.length;o++)yield new Promise(((n,l)=>{const a=new XMLHttpRequest;a.open("PUT",t[o],!0),a.upload.onprogress=t=>{var e;t.lengthComputable&&(r[o]=t.loaded,null===(e=this.filetsone)||void 0===e||e.triggerHook("multipart_upload_progress",i,r.reduce(((t,e)=>t+e),0)))},a.onload=()=>{if(a.status>=200&&a.status<300){const t=a.getResponseHeader("ETag");if(!t)return void l(new Error(`Missing ETag for part ${o+1}`));s.push({PartNumber:o+1,ETag:t}),r[o]=e[o].size,n(void 0)}else l(new Error(`Failed to upload part ${o+1}, status: ${a.status}`))},a.onerror=()=>l(new Error(`Network error while uploading part ${o+1}`)),a.send(e[o])}));return s}))}finalizeUpload(t,e){return r(this,void 0,void 0,(function*(){const i=yield fetch(this.settings.finalizeMultipartUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({request_id:t,parts:e})});if(!i.ok)throw new Error("Failed to finalize upload");const s=yield i.json();return this.filetsone&&this.filetsone.triggerHook("finalize_multipart_upload",t,e,s),s}))}}class n{upload(t,e){return i=this,s=void 0,o=function*(){try{const i=new FormData;i.append("file",e);const s=yield fetch(t.url,{method:"POST",body:i,headers:{Accept:"application/json"}});if(s.ok)return yield s.json();console.error("File upload failed.",s.statusText)}catch(t){console.error("Error during file upload:",t)}throw new Error("Upload failed")},new((r=void 0)||(r=Promise))((function(t,e){function n(t){try{a(o.next(t))}catch(t){e(t)}}function l(t){try{a(o.throw(t))}catch(t){e(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof r?i:new r((function(t){t(i)}))).then(n,l)}a((o=o.apply(i,s||[])).next())}));var i,s,r,o}}class l{constructor(){this.queue=[]}add(t){this.queue.push(t)}remove(t){t>-1&&t<this.queue.length&&this.queue.splice(t,1)}clear(){this.queue=[]}get(){return this.queue}}class a{constructor(t){this.uploadOnDrop=!1,this.mode="server",this.url="",this.uploader=new n,this.files=new l,this.hooks=new Map,this.element=this.getElement(t),this.s3Settings=new s,this.settings=new i,this.setupEventListeners()}setFileSelector(t){this.getElement(t).addEventListener("click",this.openFileDialog.bind(this))}setUploadMode(t){this.mode=t,"s3"==this.mode?this.uploader=new o:"server"==this.mode&&(this.uploader=new n)}process(){let t=this.files.get();if(null!==t){this.triggerHook("processing",t);for(let e=0;e<t.length;e++)this.uploader.upload(this,t[e])}}registerHook(t,e){this.hooks.has(t)||this.hooks.set(t,[]),this.hooks.get(t).push(e)}triggerHook(t,...e){var i;null===(i=this.hooks.get(t))||void 0===i||i.forEach((t=>t(...e)))}openFileDialog(){let t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("multiple","true"),t.style.visibility="hidden",t.addEventListener("change",(e=>{let i=t.files;if(i&&i.length>0)for(let t=0;t<i.length;t++)this.files.add(i[t]),this.triggerHook("dropped",i[t])})),t.setAttribute("id","filetsone-file-input"),t.click()}getFilesFromInput(){}getElement(t){const e=document.querySelector(t);if(!e)throw new Error(`Element not found: ${t}`);return e}supportsFolderDrop(){return"DataTransferItem"in window&&"webkitGetAsEntry"in DataTransferItem.prototype}addFilesFromFolder(t,e){t.createReader().readEntries((t=>{for(let i of t)i.isFile?i.file((t=>{t.dirPath=`${e}/${t.name}`,this.triggerHook("dropped",t),this.files.add(t)})):i.isDirectory&&this.addFilesFromFolder(i,`${e}/${i.name}`)}))}addFilesFromItems(t){for(const e of t){const t=e.webkitGetAsEntry();if(t&&t.isDirectory)this.addFilesFromFolder(t,t.name);else if(t&&t.isFile){const t=e.getAsFile();if(!t)continue;this.triggerHook("dropped",t),this.files.add(t),this.settings.uploadOnDrop&&this.uploader.upload(this,t)}}}setupEventListeners(){["dragenter","dragover","dragleave","drop"].forEach((t=>{this.element.addEventListener(t,(t=>t.preventDefault()))})),this.element.addEventListener("drop",(t=>{return e=this,i=void 0,r=function*(){var e,i;const s=null===(e=t.dataTransfer)||void 0===e?void 0:e.files;let r=null===(i=t.dataTransfer)||void 0===i?void 0:i.items;if(this.supportsFolderDrop()&&r)this.addFilesFromItems(r);else if(s&&s.length>0)for(let t=0;t<s.length;t++)this.files.add(s[t]),this.triggerHook("dropped",s[t]),this.settings.uploadOnDrop&&this.uploader.upload(this,s[t])},new((s=void 0)||(s=Promise))((function(t,o){function n(t){try{a(r.next(t))}catch(t){o(t)}}function l(t){try{a(r.throw(t))}catch(t){o(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(n,l)}a((r=r.apply(e,i||[])).next())}));var e,i,s,r}))}}var d=e.A;export{d as default};