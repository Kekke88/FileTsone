var t={d:(e,i)=>{for(var r in i)t.o(i,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:i[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{A:()=>a});class i{constructor(){this.url="",this.uploadOnDrop=!1,this.chunkSize=10485760}}class r extends i{constructor(){super(...arguments),this.initiateMultipartUrl="",this.fetchPresignUrl="",this.finalizeMultipartUrl=""}valid(){return""!==this.initiateMultipartUrl&&""!==this.fetchPresignUrl&&""!==this.finalizeMultipartUrl}}var s=function(t,e,i,r){return new(i||(i=Promise))((function(s,o){function n(t){try{a(r.next(t))}catch(t){o(t)}}function l(t){try{a(r.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(n,l)}a((r=r.apply(t,e||[])).next())}))};class o{constructor(){this.settings=new r}upload(t,e){return s(this,void 0,void 0,(function*(){if(this.settings=t.s3Settings,this.filetsone=t,!this.settings.valid())throw new Error("Settings invalid");const i=this.splitFile(e),r=yield this.initiateUpload(e),s=yield this.getPresignedUrls(r,i.length),o=yield this.uploadChunks(s,i);return this.finalizeUpload(r,o)}))}splitFile(t){const e=Math.ceil(t.size/this.settings.chunkSize),i=[];for(let r=0;r<e;r++)i.push(t.slice(r*this.settings.chunkSize,(r+1)*this.settings.chunkSize));return i}initiateUpload(t){return s(this,void 0,void 0,(function*(){this.filetsone&&this.filetsone.triggerHook("initiate_multipart_upload",t,this.settings.initiateMultipartUrl);const e=yield fetch(this.settings.initiateMultipartUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t.name})});if(!e.ok)throw new Error("Failed to initiate upload");const{key:i}=yield e.json();return i}))}getPresignedUrls(t,e){return s(this,void 0,void 0,(function*(){this.filetsone&&this.filetsone.triggerHook("get_multipart_presign_urls",t,e);const i=[];for(let r=1;r<=e;r++){const e=yield fetch(`${this.settings.fetchPresignUrl}?requestId=${t}&partNumber=${r}`);if(!e.ok)throw new Error(`Failed to get presigned URL for part ${r}`);const{url:s}=yield e.json();i.push(s)}return i}))}uploadChunks(t,e){return s(this,void 0,void 0,(function*(){this.filetsone&&this.filetsone.triggerHook("upload_multipart_chunk",t,e);const i=[];for(let r=0;r<e.length;r++){const s=yield fetch(t[r],{method:"PUT",body:e[r]});if(!s.ok)throw new Error(`Failed to upload part ${r+1}`);const o=s.headers.get("ETag");if(!o)throw new Error(`Missing ETag for part ${r+1}`);i.push({PartNumber:r+1,ETag:o})}return i}))}finalizeUpload(t,e){return s(this,void 0,void 0,(function*(){this.filetsone&&this.filetsone.triggerHook("finalize_multipart_upload",t,e);const i=yield fetch(this.settings.finalizeMultipartUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({request_id:t,parts:e})});if(!i.ok)throw new Error("Failed to finalize upload");return yield i.json()}))}}class n{upload(t,e){return i=this,r=void 0,o=function*(){try{const i=new FormData;i.append("file",e);const r=yield fetch(t.url,{method:"POST",body:i,headers:{Accept:"application/json"}});if(r.ok)return yield r.json();console.error("File upload failed.",r.statusText)}catch(t){console.error("Error during file upload:",t)}throw new Error("Upload failed")},new((s=void 0)||(s=Promise))((function(t,e){function n(t){try{a(o.next(t))}catch(t){e(t)}}function l(t){try{a(o.throw(t))}catch(t){e(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(n,l)}a((o=o.apply(i,r||[])).next())}));var i,r,s,o}}class l{constructor(){this.queue=[]}add(t){this.queue.push(t)}clear(){this.queue=[]}get(){return this.queue}}class a{constructor(t){this.uploadOnDrop=!1,this.mode="server",this.url="",this.uploader=new n,this.files=new l,this.hooks=new Map,this.element=this.getElement(t),this.s3Settings=new r,this.settings=new i,this.setupEventListeners()}setUploadMode(t){this.mode=t,"s3"==this.mode?this.uploader=new o:"server"==this.mode&&(this.uploader=new n)}process(){let t=this.files.get();if(null!==t){this.triggerHook("processing",t);for(let e=0;e<t.length;e++)this.uploader.upload(this,t[e])}}registerHook(t,e){this.hooks.has(t)||this.hooks.set(t,[]),this.hooks.get(t).push(e)}triggerHook(t,...e){var i;null===(i=this.hooks.get(t))||void 0===i||i.forEach((t=>t(...e)))}getElement(t){const e=document.querySelector(t);if(!e)throw new Error(`Element not found: ${t}`);return e}supportsFolderDrop(){return"DataTransferItem"in window&&"webkitGetAsEntry"in DataTransferItem.prototype}addFilesFromFolder(t,e){t.createReader().readEntries((t=>{for(let i of t)i.isFile?i.file((t=>{t.dirPath=`${e}/${t.name}`,this.files.add(t)})):i.isDirectory&&this.addFilesFromFolder(i,`${e}/${i.name}`)}))}addFilesFromItems(t){for(const e of t){const t=e.webkitGetAsEntry();if(t&&t.isDirectory)this.addFilesFromFolder(t,t.name);else if(t&&t.isFile){const t=e.getAsFile();if(!t)continue;this.files.add(t),this.settings.uploadOnDrop&&this.uploader.upload(this,t)}}}setupEventListeners(){["dragenter","dragover","dragleave","drop"].forEach((t=>{this.element.addEventListener(t,(t=>t.preventDefault()))})),this.element.addEventListener("drop",(t=>{return e=this,i=void 0,s=function*(){var e,i;const r=null===(e=t.dataTransfer)||void 0===e?void 0:e.files;this.triggerHook("dropped",r);let s=null===(i=t.dataTransfer)||void 0===i?void 0:i.items;if(this.supportsFolderDrop()&&s)this.addFilesFromItems(s);else if(r&&r.length>0)for(let t=0;t<r.length;t++)this.files.add(r[t]),this.settings.uploadOnDrop&&this.uploader.upload(this,r[t])},new((r=void 0)||(r=Promise))((function(t,o){function n(t){try{a(s.next(t))}catch(t){o(t)}}function l(t){try{a(s.throw(t))}catch(t){o(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof r?i:new r((function(t){t(i)}))).then(n,l)}a((s=s.apply(e,i||[])).next())}));var e,i,r,s}))}}var h=e.A;export{h as default};